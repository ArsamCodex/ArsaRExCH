@page "/Bet1"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inject NavigationManager NavigationManager
@using System.Security.Claims
@inject AuthenticationStateProvider _AuthenticationStateProvider
@inject HttpClient Http
@attribute [Authorize]
@rendermode InteractiveServer
@inject ArsaRExCH.Interface.BetInterface _interface
@inject ArsaRExCH.Interface.WalletInterface<double> _interface2
@using ArsaRExCH.Model
@using ArsaRExCH.Components.Pages
@using ArsaRExCH.Components.MyComponents
@inject NavigationManager manager
@inject EventService EventService




<B3 @ref="br"></B3>

<div style="@divStyle">
    @divText
</div>

<br />

<hr />
<br />
<EditForm Model="BetModel" OnValidSubmit="HandleValidSubmit" FormName="Name">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-container" style="display: inline-flex; flex-wrap: wrap; gap: 10px; align-items: center;width:auto">
        <div class="form-group" style="width: auto;">
            <label for="btcPriceExpireBet">BTC Price Expire Bet</label>
            <InputNumber @bind-Value="BetModel.BtcPriceExpireBet" id="btcPriceExpireBet" class="form-control form-control-sm" />
        </div>

        <div class="form-group" style="width: auto;">
            <label for="hitDateBTC">Hit Date BTC</label>
            <InputDate @bind-Value="BetModel.HitDateBTC" id="hitDateBTC" class="form-control form-control-sm" />
        </div>

        <div class="form-group" style="width: auto">
            <label for="betAmountBtc">Bet Amount BTC</label>
            <InputNumber @bind-Value="BetModel.BetAmountBtc" id="betAmountBtc" class="form-control form-control-sm" />
        </div>
    </div>

    <br />
    <br />

    <div class="form-container" style="display: inline-flex; flex-wrap: wrap; gap: 10px; align-items: center;width:auto">
        <div class="form-group" style="width:auto;">
            <label for="ethPriceExpireBet">ETH Price Expire Bet</label>
            <InputNumber @bind-Value="BetModel.EthPriceExpireBet" id="ethPriceExpireBet" class="form-control form-control-sm" />
        </div>

        <div class="form-group" style="width: auto;">
            <label for="hitDateETH">Hit Date ETH</label>
            <InputDate @bind-Value="BetModel.HitDateETH" id="hitDateETH" class="form-control form-control-sm" />
        </div>
        <div class="form-group" style="width: auto;">
            <label for="betAmountETH">Bet Amount ETH</label>
            <InputNumber @bind-Value="BetModel.BetAmountETH" id="betAmountETH" class="form-control form-control-sm" />
        </div>
    </div>
    <br /><br />


</EditForm>
<button class="btn btn-primary" @onclick="HandleValidSubmit">PlaceBet</button>

<style>
    .wallet-container {
        display: flex; /* Use flexbox to arrange items horizontally */
        gap: 20px; /* Space between the divs */
        justify-content: space-around; /* Distribute space evenly around the divs */
        margin-top: 20px;
    }

    .wallet {
        border: 1px solid #ccc; /* Optional: border around each wallet section */
        padding: 10px;
        border-radius: 8px; /* Rounded corners */
        width: 30%; /* Optional: controls width of each wallet section */
    }

        .wallet h3 {
            margin-top: 0; /* Remove default margin from the heading */
            font-size: 18px;
            color: #333; /* Optional: set heading color */
        }

        .wallet ul {
            list-style-type: none; /* Remove bullet points from the list */
            padding: 0; /* Remove padding from the list */
            margin: 0; /* Remove margin from the list */
        }

        .wallet li {
            margin: 5px 0; /* Space between list items */
            font-size: 16px; /* Font size for balance */
            color: #555; /* Optional: set color for balances */
        }
</style>
@user2
@code {
    private Bet BetModel = new Bet();
    private string user2 { get; set; }
    private double BtcBetAmout { get; set; }
    private string divText = "";
    private string divStyle = "";
    private string BetGeneratedHAsh { get; set; }
    private List<double> btcBalances = new List<double>();
    private List<double> ethBalances = new List<double>();
    private List<double> bnbBalances = new List<double>();
    private ArsaRExCH.Components.MyComponents.B3 br;
    private void ChangeColor()
    {
        divStyle = "background-color: green; color: white; padding: 20px; border: 1px solid #ccc;";
        divText = "Order Created";

    }

    protected override async Task OnInitializedAsync()
    {
        // Check if the user is logged in and fetch their information
        var authState = await _AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated ?? false)
        {
            user2 = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
            BetModel.HitDateBTC = DateTime.Now;
            BetModel.HitDateETH = DateTime.Now;


        }

    }

    public async Task HandleValidSubmit()
    {
        //BetModel.CompletedTime = something when bet expires is null for begin

        BetModel.IsBetActive = true;
        BetModel.ISDeleted = false;
        BetModel.UserIdSec = user2;
        BetModel.BtcPriceNow = 11200000;//Call to database
        BetModel.EthPriceNow = 11200000;//Call to database
        BetModel.OpendBetAtricle = DateTime.Now; //init at placing bet sample
        BetModel.WiningAmount = null;//calculate later

        BtcBetAmout = BetModel.BetAmountBtc;

        //First save the bet in database
        BetModel.BetSignutare = await _interface.Generatesha256();
        BetGeneratedHAsh = BetModel.BetSignutare;
        await _interface.SaveBet(BetModel);
        BetModel = new Bet();

        //Then edit balance of user
        await _interface2.EditWalletAmount(user2, BtcBetAmout);
        ChangeColor();
        await br.FetchBalancesAsync();
        // StateHasChanged();
        Thread.Sleep(10);
        manager.NavigateTo($"/BetPreview/{BetGeneratedHAsh}", true);

    }

}

